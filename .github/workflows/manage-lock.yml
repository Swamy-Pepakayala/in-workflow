name: Manage Lock

on:
  workflow_dispatch:

jobs:
  acquire:
    runs-on: self-hosted
    outputs:
      acquired: ${{ steps.acquire.outputs.acquired }}
    steps:
      - name: Acquire lock
        id: acquire
        run: |
          LOCK_FILE=/tmp/workflow.lock
          if [ -f $LOCK_FILE ]; then
            echo "Lock not acquired"
            echo "::set-output name=acquired::false"
          else
            touch $LOCK_FILE
            echo "Lock acquired"
            echo "::set-output name=acquired::true"
  
  release:
    runs-on: self-hosted
    needs: [acquire]
    if: ${{ needs.acquire.outputs.acquired == 'true' }}
    steps:
      - name: Release lock
        run: |
          LOCK_FILE=/tmp/workflow.lock
          rm -f $LOCK_FILE
          echo "Lock released"
